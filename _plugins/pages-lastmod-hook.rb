#!/usr/bin/env ruby
#
# Check for changed posts

Jekyll::Hooks.register :pages, :post_init do |page|

    puts page.path
    commit_num = `test -f "#{ page.path }" && git rev-list --count HEAD "#{ page.path }"`
    lastmod_date = nil
    
    url = "https://api.github.com/repos/cve-north-stars/cve-north-stars.github.io/commits?path=#{page.path}&page=1&per_page=1"

    if commit_num.to_i > 1
      #lastmod_date = `git log -1 --pretty="%ad" --date=iso "#{ page.path }"`            
      lastmod_date = `curl -s "#{url}" | jq -r '.[0].commit.committer.date'`
    else      
      lastmod_date = `curl -s "#{url}" | jq -r '.[0].commit.committer.date'`
    end 

    if lastmod_date
      page.data['last_modified_at'] = lastmod_date  # for sitemap plugin
      page.data['last_modified_date'] = lastmod_date # for jekyll page.last_modified_date
    end

  end