# Environment Setup and Tooling


![](Resources/images/hyunwon-jang-Lahie3_T3Go-unsplash.jpg)
[](https://unsplash.com/photos/Lahie3_T3Go)

In order to perform patch analysis the following tools and scripts will be used:

- Ghidra
- BinDiff
- patch_extract
- patch_delta

Additionally, the binaries that have been patched will need to be collected for analysis. This looks different across platforms, but the basic idea remains the same.

```mermaid

graph LR;

A[Vulnerable Binary] --patch--> B[Patched Binary];

```

The idea is to collect a before and after snapshot of the vulnerable binary, and perform differential analysis. 


## Platform Security Updates

Every platform has their own mechanism for distributing feature and security updates for their operating systems. This article will focus on the Windows Update.  Additionally, we are considering the path of the related CVEs.

- [CVE-2020-1048](CVE-2020-1048.md)
- [CVE-2020-1337](CVE-2020-1337.md)
- [CVE-2020-17001](CVE-2020-17001.md)

### High level update flow

The complexity is high. Updates are distributed in many ways, sometimes just deltas. The easier path sometimes is just to full patch to specified date and then copy the file and symbols.  

### Windows Update Sources

- [Microsoft Update Catolog](https://www.catalog.update.microsoft.com/Home.aspx) - Primary website for downloading manual patches.
- 

### Cumulative / Monthly Rollups

>The left column of this page lists all the updates that have been released for this version of Windows. We recommend that you install all the updates for Windows that are available for your device.** Installing the most recent update means that you also get all the previous updates, including important security fixes.**[](https://support.microsoft.com/en-us/topic/windows-7-sp1-and-windows-server-2008-r2-sp1-update-history-720c2590-fd58-26ba-16cc-6d8f3b547599)


Windows 7 Path

- [Windows 7 SP1 and Windows Server 2008 R2 SP1 update history](https://support.microsoft.com/en-us/topic/windows-7-sp1-and-windows-server-2008-r2-sp1-update-history-720c2590-fd58-26ba-16cc-6d8f3b547599)
	- This is a list of the most recent **monthly rollup** updates for Windows 7

Windows 10 Path


#### Notes
patch diff timeline. ISO and update acquisition.  perhaps for printer CVEs analyzed Patch diff time line. ISO and Update acquisition. Show OS release date or version and grab iso. Apply kB just before or just after. Fleeting problem.  Hard to get micro patches?



#### How to download an update remotely
- https://support.microsoft.com/en-us/topic/how-to-download-a-windows-update-manually-9f939f2d-c136-8533-cf83-39292c44bffa

### Security only updates

From MSRC can find the security only specific KB. 




## Finding the relevant patch

```mermaid

graph LR;

A[CVE] --> B[MSRC];
B --> C[KB article];
C --> D[MUC];
D --> E[MSU]


```


For a particular CVE the path for Windows is particularly straightforward. From the references section the **CVE** details on [MITRE's page](https://cve.mitre.org), a link to Microsoft's Security Response Center (**MSRC**).  From the MSRC a link to the appropriate Knowledge Base (**KB**) article can be found.  The KB article will list a specific ID ( ie. *KB4556799*) than can finally be searched for in Microsoft Update Catalog (**MUC**). MUC will then provide a download link to a Microsoft Standalone Update (MSU) containing several update files for the corresponding update.

### CVE-1048-2020 relevant patch

Here is a run through with links included for *CVE-2020-1048*.

- CVE - Browse to the corresponding [CVE listing](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1048). 
	- Find link to corresponding MSRC
- [MSRC article](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-1048)
	- From here the KB number for the corresponding OS can be found:
		- Windows 7 for x64-based Systems Service Pack 1
			- Monthly Rollup - 4556836 -  https://support.microsoft.com/help/4556836
			- Security Only - 4556843 - https://support.microsoft.com/help/4556843
		- Windows 10 Version 1903 for x64-based Systems
			- 4556799 - https://support.microsoft.com/help/4556799
	- Also of note is the date to help determine what is included in this patch relative to the current file system.
		- May 12, 2020
- KB - article describing details of CVE and other patch requirements
	- Windows 7 for x64-based Systems Service Pack 1
			- Monthly Rollup - 4556836 -  https://support.microsoft.com/help/4556836
			- Security Only - 4556843 - https://support.microsoft.com/help/4556843
	- Windows 10 Version 1903 for x64-based Systems
		- 4556799 - https://support.microsoft.com/help/4556799
- MSU - actual download from catalog
	- Windows 7 for x64-based Systems Service Pack 1
		- [Monthly Rollup](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4556836)
		- [Security Only](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4556843)
	- Windows 10 Version 1903 for x64-based Systems
		- [Security Update](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4556799)


#### Timing

Need to decided whether to get security only, or cumulative. 

```
insert date graph here
```

CVE release dates KB and cumulative ones. 


### Extracting the patch

```
expand something something darkside
```

### Patch extraction automation


https://gist.githubusercontent.com/wumb0/306f97dc8376c6f53b9f9865f60b4fb5/raw/cfaaaa08042199f927940264f2e202161c148002/PatchExtract.ps1


## Finding the needle

Out of all the mess, the files, how do you know which files are relevant?  Good question. Hints, which dlls / servers are responsible for the specific functionality.  Collect list of related DLLs, see if any show up in the specific update.

????


## Finding the binaries to compare

```mermaid
graph LR;
 
a --> b;
```


### Naive method

Base OS --> N-1 (capture files and symbols) --> N (capture files and symbols)

#### Finding the N-1 Update


What if you don't start from a Base OS? 


### Leveraging WinSxS


Current -> Base file -> Patched MM-YYYY



## Applying the Patch


## Binary Diffing Tools

There are several options:
- asd
- asdf
- adsf


This article will focus Ghidra and BINDIFF


### Installation

### Workflow Overview



### File and Symbol collection

#### Initial install



##### Windows 7 Path
- Install from ISO
- Disable Updates
- Download symbols for system32
	- `symchk /r c:\windows\system32 /s SRV*c:\symbols\*http://msdl.microsoft.com/download/symbols`
		- Took about 1.5 hours for Win7 at 150 MB down (~1.2GB *fact check this size*)

##### Windows 10 Path