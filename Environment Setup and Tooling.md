# Environment Setup and Tooling


![](Resources/images/hyunwon-jang-Lahie3_T3Go-unsplash.jpg)
[](https://unsplash.com/photos/Lahie3_T3Go)



## Tools and Scripts

In order to perform patch analysis the following tools and scripts will be used:

- [Ghidra](https://ghidra-sre.org/) - the primary SRE tool
	- Download the main zip package
- [ghidra-patchdiff-correlator](https://github.com/threatrack/ghidra-patchdiff-correlator) - plugin to improve default Ghidra version tracking correlators
	- Download main zip
- [Java](https://www.java.com/) 11 64-bit Runtime and Development Kit (JDK) + (Ghidra Dependency)
- [Patch Extract](Resources/Patch%20Extract.md) - script used to extract and organize downloaded Microsoft Standalone Update (MSU) files. 
- [Patch Delta](Resources/Patch%20Delta.md) (if using Windows10) - to generate binaries from the forward and reverse differentials from Windows 10 MSU files.
- [symchk](https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/symchk) - Microsoft Utility to download relevant symbols for Microsoft binaries



### Installation

1. Install minimum+ version of Java Runtime and JDK.
2. Download and unzip Ghidra to local directory. `C:\Ghidra` or some other place
3. Download and unzip ghidra-patchdiff-correlator.zip.
	1. > In Ghidra: `File` -> `Install Extensions` hit the top right green `+` icon; then select the `ghidra_<VERSION>_PatchDiffCorrelator.zip` (that you either build from source with the GhidraDev plugin or downloaded pre-build from the [releases section](https://github.com/threatrack/ghidra-patchdiff-correlator/releases); please make sure `VERSION` matches your Ghidra version!)
4. Just need python for [Patch Delta](Resources/Patch%20Delta.md) and [Patch Extract](Resources/Patch%20Extract.md). 
5. Symchk is included with [Microsoft's Debugging Tool for Windows](https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/debugger-download-tools)

## Preparation 

### File  Collection (suggested)

Gather all the binaries for Patch Diffing into a single directory. 

#### Sample collection of files from [Security Patches](Security%20Patches.md) conclusion.

```bash
$ find WindowsPrintSpooler/
WindowsPrintSpooler/
WindowsPrintSpooler/2020-04
WindowsPrintSpooler/2020-04/p..ooler-core-localspl_6.1.7601.24383
WindowsPrintSpooler/2020-04/p..ooler-core-localspl_6.1.7601.24383/localspl.dll
WindowsPrintSpooler/2020-04/p..ooler-core-localspl_6.1.7601.24383/winprint.dll
WindowsPrintSpooler/2020-05
WindowsPrintSpooler/2020-05/p..ooler-core-localspl_6.1.7601.24554
WindowsPrintSpooler/2020-05/p..ooler-core-localspl_6.1.7601.24554/localspl.dll
WindowsPrintSpooler/2020-05/p..ooler-core-localspl_6.1.7601.24554/winprint.dll
WindowsPrintSpooler/2020-08
WindowsPrintSpooler/2020-08/p..ooler-core-localspl_6.1.7601.24559
WindowsPrintSpooler/2020-08/p..ooler-core-localspl_6.1.7601.24559/localspl.dll
WindowsPrintSpooler/2020-08/p..ooler-core-localspl_6.1.7601.24559/winprint.dll
WindowsPrintSpooler/2020-11
WindowsPrintSpooler/2020-11/p..ooler-core-localspl_6.1.7601.24562
WindowsPrintSpooler/2020-11/p..ooler-core-localspl_6.1.7601.24562/localspl.dll
WindowsPrintSpooler/2020-11/p..ooler-core-localspl_6.1.7601.24562/winprint.dll
```


### Symbol Collection (mostly required)
Symbols improve Ghidra's ability to analyze a binary and also speed up the Patch Diffing process.

Run symchk on all the collected binaries and cache the symbols locally. 

`symchk /r /v /s SRV*c:\symbols*https://msdl.microsoft.com/download/symbols .`

This command will recursively download symbols from `https://msdl.microsoft.com/download/symbols` and cache them in `c:\symbols`.

```powershell

PS C:\Users\user\Desktop\WindowsPrintSpooler> symchk /r /v /s SRV*c:\symbols*https://msdl.microsoft.com/download/symbols .

.
.
.
.

[SYMCHK] PDB: "c:\symbols\winprint.pdb\BA411BB6DA07421F9EDF79D8EE6F218E2\winprint.pdb"
[SYMCHK] CV: RSDS
[SYMCHK] CV DWORD: 0x53445352
[SYMCHK] CV Data:  winprint.pdb
[SYMCHK] PDB Sig:  0
[SYMCHK] PDB7 Sig: {BA411BB6-DA07-421F-9EDF-79D8EE6F218E}
[SYMCHK] Age: 2
[SYMCHK] PDB Matched:  TRUE
[SYMCHK] DBG Matched:  TRUE
[SYMCHK] Line nubmers: FALSE
[SYMCHK] Global syms:  FALSE
[SYMCHK] Type Info:    FALSE
[SYMCHK] ------------------------------------
SymbolCheckVersion  0x00000002
Result              0x00030001
DbgFilename
DbgTimeDateStamp    0x5f8667a4
DbgSizeOfImage      0x0000e000
DbgChecksum         0x00018262
PdbFilename         c:\symbols\winprint.pdb\BA411BB6DA07421F9EDF79D8EE6F218E2\winprint.pdb
PdbSignature        {00000000-0000-0000-0000-000000000000}
PdbDbiAge           0x00000000
[SYMCHK] [ 0x00000000 - 0x00030001 ] Checked "C:\Users\user\Desktop\WindowsPrintSpooler\2020-11\p..ooler-core-localspl_6.1.7601.24562\winprint.dll"

SYMCHK: FAILED files = 0
SYMCHK: PASSED + IGNORED files = 11
```


