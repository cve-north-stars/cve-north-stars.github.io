# Security Patches

![](Resources/images/numendil--IYOJNgGhpk-unsplash.jpg)[](https://unsplash.com/photos/-IYOJNgGhpk)

## Platform Security Updates

Every platform has their own mechanism for distributing feature and security updates for their operating systems.  These updates provide critical security fixes (or patches) necessary to protect systems and users. This section of the article will use the term *updates* and *patches* interchangeably. 

The Windows path will be taken and specific focus given to the security patches related to the previously analyzed CVEs.

- [CVE-2020-1048](CVE-2020-1048.md)
- [CVE-2020-1337](CVE-2020-1337.md)
- [CVE-2020-17001](CVE-2020-17001.md)

### Windows Update Support Lifecycle

The complexity of managing software updates across the many versions of Windows is vast.  There are several [versions](https://en.wikipedia.org/wiki/List_of_Microsoft_Windows_versions) of the operating system to consider with varying [lifecycle](https://docs.microsoft.com/en-us/lifecycle/) support expectations across products.  

A quick view of recent older Windows versions [lifecycle suport](https://docs.microsoft.com/en-us/lifecycle/products/?terms=windows):

|Listing|Start Date|Mainstream End Date|Extended End Date|
|--- |--- |--- |--- |
|Windows XP|12/31/2001|04/14/2009|04/08/2014|
|Windows 7|10/22/2009|01/13/2015|01/14/2020|

And for Windows 10, which uses an auto-update channel with 2 major releases a year, the lifecycle support generally lasts between 18 and 20 months from the release date.

A recent look being[](https://docs.microsoft.com/en-us/windows/release-health/release-information):

|Version|Servicing option|Availability date|OS build|Latest revision date|End of service: Home, Pro, Pro Education, Pro for Workstations and IoT Core|End of service: Enterprise, Education and IoT Enterprise|
|--- |--- |--- |--- |--- |--- |--- |
|20H2|Semi-Annual Channel|2020-10-20|19042.804|2021-02-09|2022-05-10|2023-05-09|
|2004|Semi-Annual Channel|2020-05-27|19041.804|2021-02-09|2021-12-14|2021-12-14|
|1909|Semi-Annual Channel|2019-11-12|18363.1411|2021-02-16|2021-05-11|2022-05-10|
|1809|Semi-Annual Channel|2019-03-28|17763.1790|2021-02-16|End of service|2021-05-11|
|1809|Semi-Annual Channel (Targeted)|2018-11-13|17763.1790|2021-02-16|End of service|2021-05-11|
|1803|Semi-Annual Channel|2018-07-10|17134.2026|2021-02-09|End of service|2021-05-11|
|1803|Semi-Annual Channel (Targeted)|2018-04-30|17134.2026|2021-02-09|End of service|2021-05-11|


### Windows Update Sources

- [Microsoft Update Catolog](https://www.catalog.update.microsoft.com/Home.aspx) 
- [Windows Server Update Services](https://en.wikipedia.org/wiki/Windows_Server_Update_Services) 
- [Microsoft Update](https://www.update.microsoft.com/) 

Windows has 3 primary sources for obtaining updates. Updates can be automated for a workstation by using the default [Microsoft Update](https://www.update.microsoft.com/) or more fine grained controlled by corporate admins using Windows Server Update Services ([WSUS](https://en.wikipedia.org/wiki/Windows_Server_Update_Services)).  This article will focus on the only practical method to download specific patches based on CVE or timeframe. The ability to serach for a specific patch is available using the [Microsoft Update Catolog](https://www.catalog.update.microsoft.com/Home.aspx). 

###  Types of Windows Updates

Windows updates come in all [shapes and sizes](https://docs.microsoft.com/en-us/troubleshoot/windows-client/deployment/standard-terminology-software-updates). The goal for the Windows platform, or really any platform, is to have all of its users running fully patched machines.  Typically, the updates will contain all the files necessary to fully patch the system being updated. These are called **cumulative updates** for Windows 10 and **Monthly Rollups** for Windows 7.  Windows also issues **security only** to address specific CVEs.  For [Patch Diffing Analysis](Patch%20Diffing%20Analysis.md), the latter type is ideal.  The less there is to sort through, the better.  

TODO: review types based on article.

Regarding **cumulative updates**:
>** Installing the most recent update means that you also get all the previous updates, including important security fixes.** [](https://support.microsoft.com/en-us/topic/windows-7-sp1-and-windows-server-2008-r2-sp1-update-history-720c2590-fd58-26ba-16cc-6d8f3b547599)

Updates history links (containing both types of updates):

- [Windows 7 SP1 and Windows Server 2008 R2 SP1 update history](https://support.microsoft.com/en-us/topic/windows-7-sp1-and-windows-server-2008-r2-sp1-update-history-720c2590-fd58-26ba-16cc-6d8f3b547599)
- [Windows 8.1 and Windows Server 2012 R2 update history](https://support.microsoft.com/en-us/topic/windows-8-1-and-windows-server-2012-r2-update-history-47d81dd2-6804-b6ae-4112-20089467c7a6)
- [Windows 10 update history](https://support.microsoft.com/en-us/topic/windows-10-update-history-53c270dc-954f-41f7-7ced-488578904dfe)

#### Update Availability
From the history links are details about each of the updates. Based on lifecycle support and type of update, availability typically resembles this table. 

**Update Availability**:

|Source | Cumulative | Security-Only| Next-Step|
|---|---|---|---|
| Windows Update and Microsoft Update | Yes | No | None. This update will be downloaded and installed automatically from Windows Update. |
| Microsoft Update Catalog | Yes | Yes | To get the standalone package for this update, go to the Microsoft Update Catalog website. |
| Windows Server Update Services (WSUS) | Yes | Yes | This update will automatically sync with WSUS if you configure Products and Classifications as follows: Product: Windows 10, version 1903 and later Classification: Security Updates |


So now we know different types of patches, how do we find the one we need for our particular CVE? 

## Finding the Haystack (Relevant Patches)

```mermaid

graph LR;

A[CVE] --> B[MSRC info page];
B --> C[KB article];
C --> D[MUC site];
D --> E[MSU archive]


```


This section is titled *Finding the Haystack* as an individual update (especially depending on whether or not it is **security only** or **cumulative**) will provide a large set of files of only a subset that actually relate to the specific CVE.  For a particular CVE, the path to find the haystack is as follows. 

From the references section the **CVE** details on [MITRE's page](https://cve.mitre.org), follow the link link to Microsoft's Security Response Center (**MSRC**).  From the MSRC, a link to the appropriate Knowledge Base (**KB**) article can be found.  The KB article will list a specific ID ( ie. *KB4556799*) than can finally be searched for in Microsoft Update Catalog (**MUC**). MUC will then provide a download link to a Microsoft Standalone Update (MSU) containing several update files for the corresponding update.

### CVE-1048-2020 relevant patch

Here is a run through with links included for *CVE-2020-1048*.

- CVE - Browse to the corresponding [CVE listing](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1048). 
	- Find link to corresponding MSRC
- [MSRC article](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-1048)
	- From here the KB number for the corresponding OS can be found:
		- Windows 7 for x64-based Systems Service Pack 1
			- Monthly Rollup - 4556836 -  https://support.microsoft.com/help/4556836
			- Security Only - 4556843 - https://support.microsoft.com/help/4556843
		- Windows 10 Version 1903 for x64-based Systems
			- 4556799 - https://support.microsoft.com/help/4556799
	- Also of note is the date to help determine what is included in this patch relative to the current file system.
		- May 12, 2020
- KB - article describing details of CVE and other patch requirements
	- Windows 7 for x64-based Systems Service Pack 1
			- Monthly Rollup - 4556836 -  https://support.microsoft.com/help/4556836
			- Security Only - 4556843 - https://support.microsoft.com/help/4556843
	- Windows 10 Version 1903 for x64-based Systems
		- 4556799 - https://support.microsoft.com/help/4556799
- MSU - actual download from catalog
	- Windows 7 for x64-based Systems Service Pack 1
		- [Monthly Rollup](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4556836)
		- [Security Only](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4556843)
	- Windows 10 Version 1903 for x64-based Systems
		- [Security Update](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4556799)

In the end, you want to collect and extract the relevant MSU file. 
- windows 10 - `windows10.0-kb4556799-x64_9de920d8738612baa81a751b003ff98f0ce7156b.msu`
- Windows 7
	- Security Only - `windows6.1-kb4556843-x64_b98b5ff5cd7e9989df36db39bdb735e2e354b436.msu`
	- Monthly Rollup - `windows6.1-kb4556836-x64_81f1637b7d3bf105dcf88f3256be0119a3bb6cc4.msu`
	


### Extracting the patch

Now that we have the relevant patch archive (MSU), we need to take a look inside. 

#### Manually

[Expand](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/expand) the MSU file:
```
mkdir tmp
expand -F:* .\windows6.1-kb4556843-x64_b98b5ff5cd7e9989df36db39bdb735e2e354b436.msu .\tmp\
Microsoft (R) File Expansion Utility
Copyright (c) Microsoft Corporation. All rights reserved.

Adding .\tmp\WSUSSCAN.cab to Extraction Queue
Adding .\tmp\Windows6.1-KB4556843-x64.cab to Extraction Queue
Adding .\tmp\Windows6.1-KB4556843-x64-pkgProperties.txt to Extraction Queue
Adding .\tmp\Windows6.1-KB4556843-x64.xml to Extraction Queue

Expanding Files ....

Expanding Files Complete ...
4 files total.
```

The MSU file contains 4 files with `Windows6.1-KB4556843-x64.cab` containing all  the patched files. Another expand command is required:  
```
expand -F:* .\tmp\Windows6.1-KB4556843-x64.cab .\2020-05\
.
.
.
Adding .\2020-05\amd64_ntprint.inf_31bf3856ad364e35_6.1.7601.24553_none_9983b903ea91b16c\amd64\p6disp.gpd to Extraction Queue

Expanding Files ....
Progress: 86 out of 2921 files

```

The extracted patch files for the "security-only" update contains 2921 files.  These updates can be quite large. 

#### Patch extraction automation

Following along from a recent blog post about [extracting patches in 2020](https://wumb0.in/extracting-and-diffing-ms-patches-in-2020.html), this script will run through and recursively extract the binaries into a architecture relevant directory structure:

```
Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         2/22/2021   8:07 PM                JUNK
d-----         2/22/2021   8:06 PM                MSIL
d-----         2/22/2021   8:07 PM                PATCH
d-----         2/22/2021   8:06 PM                WOW64
d-----         2/22/2021   8:06 PM                x64
d-----         2/22/2021   8:06 PM                x86
```

https://gist.githubusercontent.com/wumb0/306f97dc8376c6f53b9f9865f60b4fb5/raw/cfaaaa08042199f927940264f2e202161c148002/PatchExtract.ps1

From there it is much simpler to search for your relevant files and they are already sorted.  


## Finding the needle (Relevant Files)

Out of all the files, how do you know which files are relevant for your software component?  Good question.  Some of this will stem from your understanding of the system. What software component are you looking at? Is it a Windows service you are reviewing, or some smaller individual component? Understanding where you code lives if quite important for each one.  

Using the *Windows Print Spooler* as an example, it might be easiest to use a tool like Process Explorer or Process Hacker to understand which modules are loaded at runtime, but some of the code will be more elusive. 

### Finding  the files you care about

- insert method for doing this

Is it a service Hints, which dlls / servers are responsible for the specific functionality.  Collect list of related DLLs, see if any show up in the specific update.

MSDN. 


## Finding the binaries to compare
## Finding the binaries for comparison

```mermaid
graph LR;
 
a --> b;
```


Initial release -> subsequent patch1 -> sp2 -> actual patch for CVE.  


### Timing

Need to decided whether to get security only, or cumulative. 

```
insert date graph here
```

CVE release dates KB and cumulative ones. 


### Naive method

Base OS --> N-1 (capture files and symbols) --> N (capture files and symbols)

#### Finding the N-1 Update


## Windows 10 vs Windows 7


What if you don't start from a Base OS? 


### Leveraging WinSxS


Current -> Base file -> Patched MM-YYYY





#### Notes
patch diff timeline. ISO and update acquisition.  perhaps for printer CVEs analyzed Patch diff time line. ISO and Update acquisition. Show OS release date or version and grab iso. Apply kB just before or just after. Fleeting problem.  Hard to get micro patches?



#### How to download an update remotely
- https://support.microsoft.com/en-us/topic/how-to-download-a-windows-update-manually-9f939f2d-c136-8533-cf83-39292c44bffa