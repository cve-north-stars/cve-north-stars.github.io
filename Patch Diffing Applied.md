# Patch Diffing Applied



As mentioned at the conclusion of the [Patch Diffing](Patch%20Diffing.md) section,  We will attempt to analyze the differences across the previously identified Windows Print Spooler CVEs (1048,1337,17001). We will look at each diff individually using the lens of patch diffing as an attempt to get some clarity as to why it took so many attempts to get it right.

```mermaid
gantt

    title Patch diffing sessions comparing N-1,1048,1337,17001
    dateFormat  YYYY-MM-DD
	axisFormat %Y-%m
	
	section Relevant CVEs
	N-1 :a1, 2020-04-14, 2020-05-11 
    CVE-2020-1048 :a2, 2020-05-12, 2020-06-08
	CVE-2020-1337 :a3, 2020-08-11, 2020-09-07
	CVE-2020-17001 :a4, 2020-11-10, 2020-12-07
	
    section Patch Diffing Sessions
    Session1  :l1, 2020-04-14, 2020-06-08 
    Session2 :l2, 2020-06-08, 2020-09-07
	Session3 :l3, 2020-09-07, 2020-12-07

```


## Prep

Assuming we already have Ghidra loaded with the [files needed](Environment%20Setup%20and%20Tooling.md#File%20Collection%20suggested) for diffing and [symbols downloaded](Environment%20Setup%20and%20Tooling.md#Symbol%20Collection%20mostly%20required) , it's time now to create the sessions. 

For each of the session we will need to complete the latter half of the version tracker workflow.

```mermaid

graph TD;

subgraph Prep
	A[Create Session] ---> B[Load Binary Version A];
	A[Create Session] ---> C[Load Binary Version B];
	B --> D[Pass Preconditions];
	C --> D;
	D --> E[Auto Analyze A/B];
end	
subgraph Actual Work


	E --> F[Choose / Run Correlators];
	F --> G[Generate Associations];
	G --> H[Evaluate Matches];
	H --> I[Accept Matching Functions];
	I --> J[Discover Enough Differences];
	J -- Yes --> K[End];
	J -- No --> F;
end

```

## CVE-2020-1048 Version Tracker - Session 1
```mermaid
gantt

    title Patch diffing sessions comparing N-1,1048,1337,17001
    dateFormat  YYYY-MM-DD
	axisFormat %Y-%m
	
	section Relevant CVEs
	N-1 :a1, 2020-04-14, 2020-05-11 
    CVE-2020-1048 :a2, 2020-05-12, 2020-06-08
	CVE-2020-1337 :a3, 2020-08-11, 2020-09-07
	CVE-2020-17001 :a4, 2020-11-10, 2020-12-07
	
    section Patch Diffing Sessions
    Session1  :crit, l1, 2020-04-14, 2020-06-08 
    Session2 :l2, 2020-06-08, 2020-09-07
	Session3 :l3, 2020-09-07, 2020-12-07
	


```





## CVE-2020-1337 Version Tracker - Session2
```mermaid
gantt

    title Patch diffing sessions comparing N-1,1048,1337,17001
    dateFormat  YYYY-MM-DD
	axisFormat %Y-%m
	
	section Relevant CVEs
	N-1 :a1, 2020-04-14, 2020-05-11 
    CVE-2020-1048 :a2, 2020-05-12, 2020-06-08
	CVE-2020-1337 :a3, 2020-08-11, 2020-09-07
	CVE-2020-17001 :a4, 2020-11-10, 2020-12-07
	
    section Patch Diffing Sessions
    Session1  :l1, 2020-04-14, 2020-06-08 
    Session2 :crit, l2, 2020-06-08, 2020-09-07
	Session3 :l3, 2020-09-07, 2020-12-07
	


```

## CVE-2020-17001 Version Tracker - Session3







## Example Version Tracker Workflow

#### Wizard

1. Load both binaries into the same Ghidra Project
	1. picture
2. Analyze and get symbols
3. Start **Version Tracking Wizard**
	1. Select both binaries
	2. Verify Preconditions - make sure each binary is sufficiently analyzed
4. Finally:
	1. Have both programs analyzed and ready for correlation.  


#### Correlators

>Ghidra uses Correlators to check for similar or exact matching functions and data between the two programs.

Correlators can be individually selected:

##### Automatic Version Tracking

>Automatic Version Tracking is very well suited for when you want to quickly port over your analysis markup to a new version of a binary and then analyze the not matching function again.


#### Finding Changed functions

It has the ability to find data changes, but we are ignoring that for now. 

1. Open Version Tracking Window
	1. Picture
2. Open **Match Table Filters**
	1. Picture
	2. Uncheck data, select function
		1. Accept pefectly matching functions
			1. Exact Function Bytes, Instruction and Mnemonic Matches
1. Open Version Tracking Window
	1. Picture
	2. **Select** all entries and **Accept** all
		1. Picture
2. 3. Open **Match Table Filters**
	1. Picture
	2. Uncheck association status (accepted and Blocked)
	3. Check all algorithems (except similar symbol name match ** why??)


Then manually review the changes of the remaining functions. 

Possible benign changes: 
	- Compilation differences (use of reg instead of stack.. etc)
	
	
# Conclusion