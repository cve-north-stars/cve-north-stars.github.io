tags: #cve-analysis

- metadata
	- CVE #:  CVE-2021-1678
	- Related CWE(s): [CWE-304](https://cwe.mitre.org/data/definitions/304.html)
	- Related CVE(s): CVE-2020-1113
	- created: 2021-01-29
	- title: MSRPC Printer Spooler Relay
	- web:
		- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-1678
		- https://www.crowdstrike.com/blog/cve-2021-1678-printer-spooler-relay-security-advisory/
		- https://blog.compass-security.com/2020/05/relaying-ntlm-authentication-over-rpc/
		- https://github.com/leechristensen/SpoolSample
		- https://github.com/SecureAuthCorp/impacket
	- platform: Windows
	- descriptor tags: #cve #security #printers


# CVE-2021-1678

## Summary

>This vulnerability allows an attacker to relay NTLM authentication sessions to an attacked machine, and use a printer spooler MSRPC interface to remotely execute code on the attacked machine.  

This CVE is related to several other Windows Print Spooler issues in that is leverages the Windows Print Spooler IRemoteWinSpool MSRPC interface in the end provide an arbitrary file write. In this case a user with sufficient privileges needs to be relayed. Not a privesc alone. Additionally, this leverages a similar NTLM relay attack inspired by CVE-2020-1113.


## Components affected
- **NTLM** - NT LAN Manager -*Windows Challenge/Response (NTLM) is the authentication protocol used on networks that include systems running the Windows operating system and on stand-alone systems.*
- **RPC** -  IRemoteWinSpool MSRPC interface
- **Windows Print Spooler** - RPC interface above

## Security Boundaries Crossed
_which security domains have been crossed? _

- **Network** - An unauthorized network endpoint cannot access or tamper with the code and data on a customerâ€™s device.
- **User** - A user cannot access or tamper with the code and data of another user without being authorized.

## Requirements
_what stars needed to align?_

- Authenticated user credentials (need to relay `Admin` account to perform admin functions)
- Active Directory setup (need to verify)
- `HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Print` registry key not set, which disables [RPC authentication checks](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rpce/425a7c53-c33a-4868-8e5b-2a850d40dc73), allowing the relay attack to succeed.  
- Man in the middle position - could just have execution on machine in AD


## Fundamental Issue / Root Cause
[CWE-304: Missing Critical Step in Authentication](https://cwe.mitre.org/data/definitions/304.html) - The fundamental issue in this case is that RPC authentication checks exist, but are not enforced.  

## Patch Info
- Seems like a tactical patch for now - https://support.microsoft.com/en-us/topic/managing-deployment-of-printer-rpc-binding-changes-for-cve-2021-1678-12a69652-30b9-3d61-d9f7-7201623a8b25

- Patch link : https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1678

| Release Date | Product | Platform | impact | Severity | Article | Download | Details |
|---|---|---|---|---|---|---|---|
|01/12/2021|Windows 10 Version 2004 for x64-based Systems|-|Security Feature Bypass|Important|[4598242](https://support.microsoft.com/help/4598242)|[Security Update](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4598242)|[CVE-2021-1678](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1678)|
